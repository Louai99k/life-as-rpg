# API Reference

This document provides detailed API reference for types, interfaces, and functions used throughout the application.

## Table of Contents

- [Electron API](#electron-api)
- [Database Models](#database-models)
- [Controller Types](#controller-types)
- [Prisma Types](#prisma-types)
- [Custom Hooks API](#custom-hooks-api)
- [Utility Functions](#utility-functions)

## Electron API

### ElectronAPI Interface

**Location**: [src/types/electron.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/types/electron.ts)

The main API exposed to the renderer process via the preload script.

```typescript
interface ElectronAPI {
  db: {
    query: <M extends Models, O extends QueryOperations>(
      model: M,
      operation: O,
      ...args: Parameters<PrismaClient[M][O]>
    ) => ReturnType<PrismaClient[M][O]>
    
    mutation: <M extends Models, O extends MutationOperations>(
      model: M,
      operation: O,
      ...args: Parameters<PrismaClient[M][O]>
    ) => ReturnType<PrismaClient[M][O]>
    
    controller: <K extends Controller>(
      controllerName: K,
      ...args: ControllerPayloadMap[K]
    ) => Promise<ControllerReturnMap[K]>
  }
}
```

**Global Access**:
```typescript
declare const electronAPI: ElectronAPI
```

### Controllers

**Available Controllers**:

```typescript
type Controller =
  | 'createMission'
  | 'updateMission'
  | 'progressMission'
  | 'findSkillWithCharacter'
  | 'findMagicWithCharacter'
  | 'findItemWithCharacter'
```

### Controller Payload Map

```typescript
interface ControllerPayloadMap extends Record<Controller, any[]> {
  createMission: [CreateMissionControllerPayload]
  updateMission: [UpdateMissionControllerPayload]
  progressMission: [ProgressMissionControllerPayload]
  findSkillWithCharacter: [string]  // character_ref
  findMagicWithCharacter: [string]  // character_ref
  findItemWithCharacter: [string]   // character_ref
}
```

### Controller Return Map

```typescript
interface ControllerReturnMap extends Record<Controller, any> {
  createMission: Mission
  updateMission: Mission
  progressMission: Mission
  findSkillWithCharacter: SkillWithCharacterSkill[]
  findMagicWithCharacter: MagicWithCharacterMagic[]
  findItemWithCharacter: ItemWithCharacterItem[]
}
```

## Database Models

All models are generated by Prisma from the schema. Import from `@prisma/client`:

```typescript
import type {
  characters as Character,
  missions as Mission,
  skills as Skill,
  magic as Magic,
  items as Item,
  goals as Goal,
  rewards as Reward,
  character_skills as CharacterSkill,
  character_magic as CharacterMagic,
  character_items as CharacterItem,
  mission_goals as MissionGoal,
  mission_rewards as MissionReward
} from '@prisma/client'
```

### Character

```typescript
interface characters {
  uid: string
  name: string
  money: number
  lvl: number
  lvl_points: number
  max_ki: number
  ki: number
  xp: number
}
```

### Mission

```typescript
interface missions {
  uid: string
  title: string
  description: string
  xp_reward: number
  is_completed: number  // 0 or 1 (SQLite boolean)
  type: string          // 'daily' | 'weekly' | 'custom'
  rank: string          // 'E' | 'D' | 'C' | 'B' | 'A' | 'S'
  character_ref: string
}
```

### Skill

```typescript
interface skills {
  uid: string
  name: string
  description: string
  max_lvl: number
  avatar: string | null
}
```

### Magic

```typescript
interface magic {
  uid: string
  name: string
  description: string
  max_lvl: number
  avatar: string | null
}
```

### Item

```typescript
interface items {
  uid: string
  name: string
  description: string
  in_store: number      // 0 or 1
  store_price: number
  avatar: string | null
  max_qty: number
}
```

### Goal

```typescript
interface goals {
  uid: string
  description: string
}
```

### Reward

```typescript
interface rewards {
  uid: string
  description: string | null
  reward_type: string     // 'money' | 'item' | 'skill' | 'magic'
  reward_amount: number | null
  reward_uid: string | null
  reward_lvl: number | null
}
```

### Character Skill

```typescript
interface character_skills {
  uid: string
  character_ref: string
  skill_ref: string
  lvl: number
}
```

### Character Magic

```typescript
interface character_magic {
  uid: string
  character_ref: string
  magic_ref: string
  lvl: number
}
```

### Character Item

```typescript
interface character_items {
  uid: string
  character_ref: string
  item_ref: string
  qty: number
}
```

### Mission Goal

```typescript
interface mission_goals {
  uid: string
  mission_ref: string
  goal_ref: string  // Unique
  done: number      // 0 or 1
}
```

### Mission Reward

```typescript
interface mission_rewards {
  uid: string
  mission_ref: string
  reward_ref: string
}
```

## Controller Types

### Mission Controllers

**Location**: [src/types/controllers/mission.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/types/controllers/mission.ts)

#### CreateMissionControllerPayload

```typescript
interface CreateMissionControllerPayload {
  description: string
  title: string
  rank: string          // 'E' | 'D' | 'C' | 'B' | 'A' | 'S'
  character_ref: string
  type: string          // 'daily' | 'weekly' | 'custom'
  goals: Array<{
    description: string
    uid?: string
  }>
  xp_reward: number
  rewards: Reward[]
}
```

**Example**:
```typescript
const payload: CreateMissionControllerPayload = {
  title: 'Daily Workout',
  description: 'Complete exercise routine',
  rank: 'C',
  character_ref: 'char-123',
  type: 'daily',
  xp_reward: 50,
  goals: [
    { description: '30 minutes cardio' },
    { description: '20 push-ups' }
  ],
  rewards: [
    {
      uid: 'reward-1',
      reward_type: 'money',
      reward_amount: 100,
      reward_uid: null,
      reward_lvl: null,
      description: 'Gold coins'
    }
  ]
}
```

#### UpdateMissionControllerPayload

```typescript
interface UpdateMissionControllerPayload {
  uid: string
  description?: string
  title?: string
  rank?: string
  type?: string
  goals?: Array<{
    description: string
    uid: string
  }>
  xp_reward?: number
  rewards?: Reward[]
}
```

#### ProgressMissionControllerPayload

```typescript
interface ProgressMissionControllerPayload {
  uid: string           // Mission UID
  doneGoals: string[]   // Array of goal UIDs to mark as done
}
```

**Example**:
```typescript
const payload: ProgressMissionControllerPayload = {
  uid: 'mission-123',
  doneGoals: ['goal-1', 'goal-2']
}
```

### Skill Controllers

**Location**: [src/types/controllers/skill.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/types/controllers/skill.ts)

#### SkillWithCharacterSkill

Skill with optional character skill information.

```typescript
interface SkillWithCharacterSkill extends Skill {
  character_skill: {
    uid: string
    lvl: number
  } | null
}
```

**Usage**:
```typescript
const skills = await electronAPI.db.controller(
  'findSkillWithCharacter',
  characterId
)

// skills[0].character_skill?.lvl // Current level or undefined
```

#### SkillWithCharacterSkill_M

Skill with mandatory character skill information (character has learned it).

```typescript
interface SkillWithCharacterSkill_M extends Skill {
  character_skill: {
    uid: string
    lvl: number
  }
}
```

### Magic Controllers

**Location**: [src/types/controllers/magic.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/types/controllers/magic.ts)

#### MagicWithCharacterMagic

```typescript
interface MagicWithCharacterMagic extends Magic {
  character_magic: {
    uid: string
    lvl: number
  } | null
}
```

#### MagicWithCharacterMagic_M

```typescript
interface MagicWithCharacterMagic_M extends Magic {
  character_magic: {
    uid: string
    lvl: number
  }
}
```

### Item Controllers

**Location**: [src/types/controllers/item.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/types/controllers/item.ts)

#### ItemWithCharacterItem

```typescript
interface ItemWithCharacterItem extends Item {
  character_item: {
    uid: string
    qty: number
  } | null
}
```

#### ItemWithCharacterItem_M

```typescript
interface ItemWithCharacterItem_M extends Item {
  character_item: {
    uid: string
    qty: number
  }
}
```

## Prisma Types

**Location**: [src/types/prisma.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/types/prisma.ts)

### Models

```typescript
type Models = Prisma.ModelName
// 'characters' | 'missions' | 'skills' | 'magic' | 'items' | ...
```

### Operations

```typescript
type Operations = keyof PrismaClient[Models]
```

### QueryOperations

Read-only operations:

```typescript
type QueryOperations = Extract<
  Operations,
  | 'findUnique'
  | 'findUniqueOrThrow'
  | 'findFirst'
  | 'findFirstOrThrow'
  | 'findMany'
>
```

### MutationOperations

Write operations:

```typescript
type MutationOperations = Extract<
  Operations,
  | 'create'
  | 'createMany'
  | 'createManyAndReturn'
  | 'delete'
  | 'update'
  | 'deleteMany'
  | 'updateMany'
  | 'updateManyAndReturn'
>
```

### FuncExtractor

Extracts function type from Prisma client:

```typescript
type FuncExtractor<
  M extends Models,
  O extends Operations
> = PrismaClient[M][O]
```

**Usage**:
```typescript
type FindManyCharacters = FuncExtractor<'characters', 'findMany'>
// (args?: Prisma.charactersFindManyArgs) => Promise<characters[]>
```

## Custom Hooks API

### usePrismaMutation

**Location**: [src/hooks/usePrismaMutation.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/hooks/usePrismaMutation.ts)

```typescript
function usePrismaMutation<M extends Models, O extends MutationOperations>(
  model: M,
  operation: O
): [
  (...args: Parameters<FuncExtractor<M, O>>) => Promise<ReturnType<FuncExtractor<M, O>> | undefined>,
  { isLoading: boolean; isError: boolean }
]
```

**Returns**:
- `[0]`: Mutation function
- `[1]`: State object with `isLoading` and `isError`

**Example**:
```typescript
const [createCharacter, { isLoading, isError }] = usePrismaMutation(
  'characters',
  'create'
)

await createCharacter({
  data: {
    uid: 'char-123',
    name: 'Hero',
    lvl: 1
  }
})
```

### usePrismaController

**Location**: [src/hooks/usePrismaController.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/hooks/usePrismaController.ts)

```typescript
function usePrismaController<C extends Controller, M extends Models>(
  controllerName: C,
  modelToMutate?: M | (string & {}) | M[] | (string & {})[]
): [
  (...args: ControllerPayloadMap[C]) => Promise<ControllerReturnMap[C]>,
  { isLoading: boolean; isError: boolean }
]
```

**Parameters**:
- `controllerName`: Name of the controller
- `modelToMutate`: Model(s) to invalidate in SWR cache (optional)

**Returns**:
- `[0]`: Controller function
- `[1]`: State object with `isLoading` and `isError`

**Example**:
```typescript
const [createMission, { isLoading, isError }] = usePrismaController(
  'createMission',
  'missions'
)

await createMission({
  title: 'Quest',
  description: 'Complete tasks',
  rank: 'C',
  type: 'daily',
  character_ref: 'char-123',
  xp_reward: 50,
  goals: [{ description: 'Goal 1' }],
  rewards: []
})
```

### useList

**Location**: [src/hooks/useList.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/hooks/useList.ts)

```typescript
function useList<T extends Record<string, any>>(
  initValue?: T[]
): {
  list: T[]
  add: (item: T) => void
  remove: <K extends keyof T>(key: K, value: T[K]) => void
  editList: (list: T[]) => void
  editItem: <K extends keyof T, U extends keyof T>(
    criteria: K,
    criteriaValue: T[K],
    updateField: U,
    updateFieldValue: T[U]
  ) => void
}
```

**Methods**:

#### add(item: T)

Add item to the list.

```typescript
add({ uid: '3', description: 'New item' })
```

#### remove(key: K, value: T[K])

Remove item where `item[key] === value`.

```typescript
remove('uid', '3')
```

#### editList(list: T[])

Replace entire list.

```typescript
editList([{ uid: '1', description: 'Item 1' }])
```

#### editItem(criteria, criteriaValue, updateField, updateFieldValue)

Update specific field of an item.

```typescript
editItem('uid', '1', 'description', 'Updated description')
```

## Utility Functions

### fetchData

**Location**: [src/utils/prisma/fetcher.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/utils/prisma/fetcher.ts)

Type-safe wrapper for database queries.

```typescript
function fetchData<M extends Models, O extends QueryOperations>(
  model: M,
  operation: O,
  ...args: Parameters<PrismaClient[M][O]>
): ReturnType<PrismaClient[M][O]>
```

**Example**:
```typescript
const characters = await fetchData('characters', 'findMany', {
  where: { lvl: { gte: 5 } }
})
```

### fetchController

**Location**: [src/utils/prisma/fetcher-controller.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/utils/prisma/fetcher-controller.ts)

Type-safe wrapper for controller operations.

```typescript
function fetchController<C extends Controller>(
  controllerName: C,
  ...args: ControllerPayloadMap[C]
): Promise<ControllerReturnMap[C]>
```

**Example**:
```typescript
const skills = await fetchController('findSkillWithCharacter', 'char-123')
```

### submitHelper

**Location**: [src/utils/form/submitHelper.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/utils/form/submitHelper.ts)

Helper for handling form submissions.

```typescript
async function submitHelper<T>(
  callback: () => Promise<T>,
  onSuccess?: (result: T) => void,
  onError?: (error: Error) => void
): Promise<void>
```

**Example**:
```typescript
await submitHelper(
  () => createCharacter({ data: formData }),
  (result) => {
    toast.success('Character created!')
    onClose()
  },
  (error) => {
    toast.error('Failed to create character')
  }
)
```

## Constants

**Location**: [src/constants.ts](https://github.com/Louai99k/life-as-rpg/blob/master/src/constants.ts)

### REWARD_TYPES

```typescript
const REWARD_TYPES = {
  MONEY: 'money',
  ITEM: 'item',
  MAGIC: 'magic',
  SKILL: 'skill'
} as const

type REWARD_TYPE = (typeof REWARD_TYPES)[keyof typeof REWARD_TYPES] & (string & {})
```

**Usage**:
```typescript
import { REWARD_TYPES } from '@src/constants'

const reward = {
  reward_type: REWARD_TYPES.MONEY,
  reward_amount: 100
}
```

## Type Guards

### Checking Reward Type

```typescript
function isMoneyReward(reward: Reward): boolean {
  return reward.reward_type === REWARD_TYPES.MONEY
}

function isItemReward(reward: Reward): boolean {
  return reward.reward_type === REWARD_TYPES.ITEM
}
```

### Checking Character Ownership

```typescript
function hasSkill(skill: SkillWithCharacterSkill): skill is SkillWithCharacterSkill_M {
  return skill.character_skill !== null
}

function hasItem(item: ItemWithCharacterItem): item is ItemWithCharacterItem_M {
  return item.character_item !== null
}
```

## Next Steps

- Review [Frontend](https://github.com/Louai99k/life-as-rpg/blob/master/documentation/Frontend.md) for component usage
- Explore [Electron](https://github.com/Louai99k/life-as-rpg/blob/master/documentation/Electron.md) for backend implementation
- Check [Database](https://github.com/Louai99k/life-as-rpg/blob/master/documentation/Database.md) for schema details
